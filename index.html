<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UFA Central - Payment Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* CSS optimized for dynamic rendering */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: linear-gradient(145deg, #dfc9ff 0%, #92c9ff 100%); min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header & Sections */
    header, .search-section, .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); }
    header { text-align: center; }
    .logo { color: #488daa; font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 1.1rem; }
    
    /* Inputs & Buttons */
    .search-container { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
    .search-input, select, input[type="date"] { padding: 12px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 16px; transition: all 0.3s ease; }
    .search-input { flex: 1; min-width: 250px; }
    .search-input:focus, select:focus { outline: none; border-color: #488daa; }
    
    .btn { padding: 12px 25px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-primary { background: linear-gradient(135deg, #488daa, #357a96); color: white; }
    .btn-secondary { background: #f8f9fa; color: #495057; border: 2px solid #e9ecef; }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }

    /* Dashboard Layout */
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px; }
    .card-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #333; }
    
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; }
    .summary-item { text-align: center; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .summary-value { font-size: 1.8rem; font-weight: bold; margin-bottom: 8px; }
    .summary-label { font-size: 0.8rem; color: #666; text-transform: uppercase; }
    
    .pending { background: #ffebee; color: #c62828; }
    .prepaid { background: #e8f5e8; color: #2e7d32; }
    .neutral { background: #f3f4f6; color: #374151; }

    /* Tables */
    .table-container { max-height: 400px; overflow-y: auto; border-radius: 12px; border: 1px solid #e1e5e9; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: #f8f9fa; padding: 15px 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef; position: sticky; top: 0; z-index: 10; cursor: pointer; }
    td { padding: 12px; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
    th.sort-asc::after { content: ' ‚Üë'; }
    th.sort-desc::after { content: ' ‚Üì'; }
    tfoot td { font-weight: bold; background: #f8f9fa; }

    /* Badges & Text Helpers */
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
    .status-member { background: #e3f2fd; color: #1565c0; }
    .status-non-member { background: #fff3e0; color: #ef6c00; }
    .text-red { color: #c62828; font-weight: bold; }
    .text-green { color: #2e7d32; font-weight: bold; }
    .text-link { color: #488daa; text-decoration: none; font-weight: 600; cursor: pointer; }
    .text-link:hover { color: #357a96; text-decoration: underline; }

    /* Loaders & Modals */
    .loading { text-align: center; padding: 40px; color: #666; }
    .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #488daa; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: white; padding: 30px; border-radius: 20px; width: 400px; max-width: 90%; text-align: center; position: relative; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close-modal { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; }
    
    .welcome-message { background: linear-gradient(135deg, #e8f4f8, #d4edda); border: 1px solid #b8daff; border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px; }

    /* Filters */
    .filters { display: flex; gap: 15px; flex-wrap: wrap; padding: 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-label { font-size: 0.85rem; font-weight: 600; color: #495057; text-transform: uppercase; }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard, .summary-grid { grid-template-columns: 1fr; }
        .search-container { flex-direction: column; align-items: stretch; }
        .filters { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <div class="logo">ü•è UFA Central</div>
      <div class="subtitle">Ultimate Frisbee Association Payment Tracker</div>
      <div id="lastUpdated" style="margin-top: 15px; font-size: 0.9rem; color: #888;">Updating...</div>
    </header>

    <div class="search-section">
      <h2 style="margin-top: 0; color: #333; font-size: 1.5rem;">Find Your Payment Status</h2>
      <div class="search-container">
        <input type="text" id="nameSearch" class="search-input" placeholder="Start typing your name...">
        <button id="clearSearch" class="btn btn-secondary">Clear</button>
        <button id="showAllData" class="btn btn-secondary">View All Data</button>
      </div>
      <div id="searchSuggestions" style="display: none; margin-top: 10px;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Select your name:</div>
        <div id="suggestionList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      </div>
    </div>

    <div id="loadingState" class="loading">
      <div class="spinner"></div> Loading payment data...
    </div>

    <div id="welcomeMessage" class="welcome-message" style="display: none;">
      <h3 style="margin:0 0 10px 0; color: #155724;">Welcome to UFA Payment Tracker!</h3>
      <div style="color: #155724;">Search for your name above to view your personal payment status.</div>
    </div>

    <div id="userDashboard" style="display: none;">
      <div id="personalWelcome" class="welcome-message">
        <h3 style="margin:0 0 10px 0;">Welcome back, <span id="selectedUserName"></span>!</h3>
        <div>Here's your complete payment and attendance summary</div>
      </div>

      <div class="dashboard">
        <div class="card">
          <div class="card-title">üí∞ Payment Summary</div>
          <div class="summary-grid">
            <div id="pendingSummary" class="summary-item pending">
              <div class="summary-value" id="pendingAmount">0</div>
              <div class="summary-label">Pending</div>
            </div>
            <div class="summary-item prepaid">
              <div class="summary-value" id="prepayAmount">0</div>
              <div class="summary-label">Prepaid</div>
            </div>
            <div class="summary-item neutral">
              <div class="summary-value" id="totalPayment">0</div>
              <div class="summary-label">Total Payment</div>
            </div>
          </div>
          
          <div id="pendingActionArea" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
             </div>

          <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e9ecef; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
             <div><div class="summary-label">Last Paid</div><strong id="lastPaymentDate">-</strong></div>
             <div><div class="summary-label">Amount</div><strong id="lastPaymentAmount">-</strong></div>
             <div><div class="summary-label">Covered Until</div><strong id="lastCoveredDate">-</strong></div>
          </div>
          
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef; display: flex; justify-content: space-around;">
             <div style="text-align: center;"><strong id="totalSessions" style="font-size: 1.2rem; color: #488daa;">0</strong><div class="summary-label">Total Sessions</div></div>
             <div style="text-align: center;"><strong id="avgCost" style="font-size: 1.2rem; color: #488daa;">0</strong><div class="summary-label">Avg Cost</div></div>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div class="card-title" style="margin: 0;">üìä Activity Overview</div>
              <select id="chartYearFilter" style="padding: 8px; border-radius: 8px; border: 1px solid #e1e5e9; font-size: 0.9rem; background: #f8f9fa;">
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
              </select>
          </div>
          
          <div class="summary-grid" style="margin-bottom: 25px;">
            <div class="summary-item neutral"><div class="summary-value" id="sessions2024">0</div><div class="summary-label">2024 Sessions</div></div>
            <div class="summary-item neutral"><div class="summary-value" id="sessions2025">0</div><div class="summary-label">2025 Sessions</div></div>
            <div class="summary-item neutral"><div class="summary-value" id="recentSessions">0</div><div class="summary-label">Last 30 Days</div></div>
          </div>

          <div style="position: relative; height: 250px; width: 100%;">
              <canvas id="activityChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìÖ Attendance History</div>
        <div class="filters">
            <div class="filter-group"><label class="filter-label">Month</label><select id="monthFilter" class="att-filter"><option value="all">All Months</option></select></div>
            <div class="filter-group"><label class="filter-label">Year</label><select id="yearFilter" class="att-filter"><option value="all">All Years</option><option value="2024">2024</option><option value="2025">2025</option></select></div>
            <div class="filter-group"><label class="filter-label">Location</label><select id="locationFilter" class="att-filter"><option value="all">All Locations</option></select></div>
        </div>
        <div class="table-container">
          <table id="attendanceTable">
            <thead>
              <tr>
                <th data-sort="date">Date</th>
                <th data-sort="location">Location</th>
                <th data-sort="month">Month</th>
                <th data-sort="cost">Cost</th>
                <th data-sort="status">Membership</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="allDataView" style="display: none;">
      <div class="card">
        <div class="card-title">üìã All Payment Records</div>
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Filter Status</label>
                <select id="paymentStatusFilter">
                  <option value="all">All Records</option>
                  <option value="pending">Pending Only</option>
                  <option value="prepaid">Prepaid Only</option>
                  <option value="balanced">Balanced</option>
                </select>
            </div>
            
            <div class="filter-group" id="neverPaidFilterGroup" style="display: none; justify-content: flex-end;">
                <div style="height: 21px;"></div> <label style="display: flex; align-items: center; background: white; padding: 10px; border-radius: 12px; border: 2px solid #e1e5e9; cursor: pointer;">
                    <input type="checkbox" id="neverPaidToggle" style="width: auto; margin-right: 8px;">
                    <span style="font-size: 0.9rem; font-weight: 600; color: #495057;">Never Paid Only</span>
                </label>
            </div>
        </div>
        <div class="table-container">
            <table id="allPaymentsTable">
              <thead>
                <tr>
                  <th data-sort="name">Name</th>
                  <th data-sort="pending">Pending</th>
                  <th data-sort="prepay">Prepay Bal</th>
                  <th data-sort="total">Total Paid</th>
                  <th data-sort="lastDate">Covered Until</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td>TOTAL</td>
                  <td id="totalPendingSum">0 MVR</td>
                  <td id="totalPrepaySum">0 MVR</td>
                  <td id="totalPaymentSum">0 MVR</td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
        </div>
      </div>
    </div>
  </div>

  <div id="qrModal" class="modal-overlay">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Scan to Pay</h3>
      <p style="color: #666; font-size: 0.9rem;">Scan the QR code or use account details.</p>
      <img src="payment_qr.png" alt="QR Code" style="width: 100%; max-width: 250px; border-radius: 10px; border: 1px solid #eee;" onerror="this.style.display='none'">
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
        <div style="font-size: 0.8rem; color: #888;">Account Number</div>
        <div style="font-size: 1.2rem; font-weight: bold;">7730000682000</div>
        <div style="font-size: 0.9rem;">MOHD. AMSAL</div>
      </div>
      <button class="btn btn-secondary close-modal-btn" style="margin-top: 20px;">Close</button>
    </div>
  </div>

<script>
    /**
     * jQuery-style Helper Function ($)
     */
    const $ = (selector) => {
        const els = typeof selector === 'string' 
            ? document.querySelectorAll(selector) 
            : (selector instanceof HTMLElement ? [selector] : []);
        
        const api = {
            el: els[0],
            on: (event, handler) => { els.forEach(e => e.addEventListener(event, handler)); return api; },
            click: (handler) => api.on('click', handler),
            html: (content) => { if(content === undefined) return els[0]?.innerHTML; els.forEach(e => e.innerHTML = content); return api; },
            text: (content) => { if(content === undefined) return els[0]?.innerText; els.forEach(e => e.innerText = content); return api; },
            val: (content) => { if(content === undefined) return els[0]?.value; els.forEach(e => e.value = content); return api; },
            css: (prop, value) => { els.forEach(e => e.style[prop] = value); return api; },
            show: () => { els.forEach(e => e.style.display = 'block'); return api; },
            hide: () => { els.forEach(e => e.style.display = 'none'); return api; },
            toggle: (flag) => { els.forEach(e => e.style.display = flag ? 'block' : 'none'); return api; },
            addClass: (cls) => { els.forEach(e => e.classList.add(cls)); return api; },
            removeClass: (cls) => { els.forEach(e => e.classList.remove(cls)); return api; }
        };
        return api;
    };

    const CONFIG = {
        apiKey: "AIzaSyB4FKQrbrtGpBztkZVriYkEGsXlnLXHAN0",
        sheetID: "1kI6E4J0pL4lUa2NH-FYEd2rWUE7Uzsz-CnGOg68ERtc",
        baseUrl: "https://sheets.googleapis.com/v4/spreadsheets"
    };

    let state = {
        summary: [],
        attendance: [],
        users: [],
        currentUser: null,
        sortBy: null,
        sortAsc: true
    };
    
    let chartInstance = null; // Chart instance holder

    const fmtMoney = (amt) => `${Math.abs(parseFloat(amt) || 0).toFixed(2)} MVR`;
    const parseMoney = (str) => parseFloat(String(str).replace(/[^\d.-]/g, '')) || 0;
    const parseDate = (str) => {
        if (!str) return null;
        const [d, m, y] = str.trim().split('/');
        return new Date(y, m - 1, d);
    };

    async function initApp() {
        try {
            $('#loadingState').show();
            
            const [summaryRes, attendanceRes, metaRes] = await Promise.all([
                fetch(`${CONFIG.baseUrl}/${CONFIG.sheetID}/values/Summary Sheet?key=${CONFIG.apiKey}`).then(r=>r.json()),
                fetch(`${CONFIG.baseUrl}/${CONFIG.sheetID}/values/PivotAttendance?key=${CONFIG.apiKey}`).then(r=>r.json()),
                fetch(`${CONFIG.baseUrl}/${CONFIG.sheetID}?key=${CONFIG.apiKey}&fields=properties.lastUpdateTime`).then(r=>r.json())
            ]);

            state.summary = summaryRes.values.slice(1);
            state.attendance = attendanceRes.values.slice(1);
            state.users = [...new Set(state.summary.map(r => r[1]))].filter(Boolean).sort();

            const lastUpdate = metaRes.properties?.lastUpdateTime 
                ? new Date(metaRes.properties.lastUpdateTime).toLocaleDateString()
                : new Date().toLocaleDateString();
            $('#lastUpdated').text(`Updated ${lastUpdate}`);

            populateFilters();
            setupEventListeners();
            $('#loadingState').hide();

            const urlUser = new URLSearchParams(window.location.search).get('user');
            if (urlUser && state.users.includes(decodeURIComponent(urlUser))) {
                selectUser(decodeURIComponent(urlUser));
            } else {
                $('#welcomeMessage').show();
            }

        } catch (e) {
            console.error(e);
            $('#loadingState').html(`<div class="text-red">‚ö†Ô∏è Error loading data. Please refresh.</div>`);
        }
    }

    function populateFilters() {
        const months = [...new Set(state.attendance.map(r => r[2]))].filter(Boolean);
        const locations = [...new Set(state.attendance.map(r => r[1]))].filter(Boolean);

        const monthOpts = months.map(m => `<option value="${m}">${m}</option>`).join('');
        const locOpts = locations.map(l => `<option value="${l}">${l}</option>`).join('');

        $('#monthFilter').html(`<option value="all">All Months</option>${monthOpts}`);
        $('#locationFilter').html(`<option value="all">All Locations</option>${locOpts}`);
    }

    function renderUserDashboard(userName) {
        $('#welcomeMessage').hide();
        $('#allDataView').hide();
        $('#userDashboard').show();
        $('#selectedUserName').text(userName);

        const summaryRow = state.summary.find(r => r[1] === userName);
        const attRows = state.attendance.filter(r => r[0] === userName);

        if (summaryRow) {
            const pending = parseMoney(summaryRow[2]);
            const prepay = parseMoney(summaryRow[3]);
            
            $('#pendingAmount').text(fmtMoney(pending));
            $('#prepayAmount').text(fmtMoney(prepay));
            $('#totalPayment').text(fmtMoney(summaryRow[4]));
            $('#lastPaymentDate').text(summaryRow[7] || '-');
            $('#lastPaymentAmount').text(summaryRow[8] ? fmtMoney(parseMoney(summaryRow[8])) : '-');
            $('#lastCoveredDate').text(summaryRow[9] || '-');

            // --- QR LOGIC: Image Left, Text Right ---
            if (pending > 0) {
                $('#pendingActionArea').html(`
                    <div style="background: #fff0f0; padding: 15px; border-radius: 12px; border: 1px solid #ffcdd2; display: flex; align-items: center; justify-content: center; gap: 20px;">
                        <div style="flex-shrink: 0; cursor: pointer;" onclick="$('#qrModal').css('display', 'flex')">
                            <img src="payment_qr.png" alt="Scan to Pay" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; display: block;">
                            <div style="font-size: 0.7rem; color: #666; text-align: center; margin-top: 4px;">(Click to Enlarge)</div>
                        </div>
                        
                        <div>
                            <p style="margin: 0; line-height: 1.5; text-align: left;">
                                <strong style="color: #c62828; font-size: 1.1rem;">‚ö†Ô∏è Outstanding Balance: ${fmtMoney(pending)}</strong><br>
                                <span style="color: #555;">Transfer to: <strong>7730000682000</strong> (MOHD. AMSAL)</span>
                            </p>
                        </div>
                    </div>
                `).show();
            } else {
                $('#pendingActionArea').hide();
            }
        }

        // Stats
        const paidSessions = attRows.filter(r => parseMoney(r[4]) > 0);
        const totalCost = paidSessions.reduce((acc, r) => acc + parseMoney(r[4]), 0);
        const avg = paidSessions.length ? totalCost / paidSessions.length : 0;
        
        $('#totalSessions').text(attRows.length);
        $('#avgCost').text(Math.round(avg) + ' MVR');
        $('#sessions2024').text(attRows.filter(r => r[3]?.includes('2024')).length);
        $('#sessions2025').text(attRows.filter(r => r[3]?.includes('2025')).length);
        
        const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        $('#recentSessions').text(attRows.filter(r => parseDate(r[3]) >= thirtyDaysAgo).length);

        renderAttendanceTable(attRows);
        
        // --- Render Activity Chart ---
        renderActivityChart(attRows);
    }

    // --- Chart.js Rendering ---
    function renderActivityChart(rows) {
        const ctx = document.getElementById('activityChart').getContext('2d');
        const selectedYear = $('#chartYearFilter').val();
        
        // 1. Initialize buckets
        const stats = Array.from({length: 12}, () => ({ count: 0, totalCost: 0 }));
        
        // 2. Aggregate Data
        rows.forEach(r => {
            const date = parseDate(r[3]); 
            if (date && date.getFullYear().toString() === selectedYear) {
                const monthIdx = date.getMonth(); 
                stats[monthIdx].count++;
                stats[monthIdx].totalCost += parseMoney(r[4]); 
            }
        });

        const counts = stats.map(s => s.count);
        const avgCosts = stats.map(s => s.count ? (s.totalCost / s.count).toFixed(2) : 0);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Sessions',
                    data: counts,
                    backgroundColor: 'rgba(72, 141, 170, 0.6)',
                    borderColor: 'rgba(72, 141, 170, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    hoverBackgroundColor: 'rgba(72, 141, 170, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                return [` Sessions: ${context.raw}`, ` Avg Cost: ${avgCosts[idx]} MVR`];
                            }
                        }
                    },
                    legend: { display: false }
                }
            }
        });
    }

    function renderAttendanceTable(data) {
        const mFilter = $('#monthFilter').val();
        const yFilter = $('#yearFilter').val();
        const lFilter = $('#locationFilter').val();
        
        let rows = data.filter(r => {
            if (mFilter !== 'all' && r[2] !== mFilter) return false;
            if (yFilter !== 'all' && !r[3].includes(yFilter)) return false;
            if (lFilter !== 'all' && r[1] !== lFilter) return false;
            return true;
        });

        if (state.sortBy) {
            rows.sort((a, b) => {
                let valA, valB;
                switch(state.sortBy) {
                    case 'date': valA = parseDate(a[3]); valB = parseDate(b[3]); break;
                    case 'cost': valA = parseMoney(a[4]); valB = parseMoney(b[4]); break;
                    default: valA = a[1]; valB = b[1];
                }
                return state.sortAsc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
        }

        const html = rows.length ? rows.map(r => `
            <tr>
                <td>${r[3]}</td>
                <td>${r[1]}</td>
                <td>${r[2]}</td>
                <td>${fmtMoney(r[4])}</td>
                <td><span class="status-badge ${r[6] === 'Non-Member' ? 'status-non-member' : 'status-member'}">${r[6] || 'Member'}</span></td>
            </tr>
        `).join('') : `<tr><td colspan="5" class="loading">No records found.</td></tr>`;

        $('#attendanceTable tbody').html(html);
    }

    function renderAllPayments() {
        $('#welcomeMessage').hide();
        $('#userDashboard').hide();
        $('#allDataView').show();

        const statusFilter = $('#paymentStatusFilter').val();
        const showNeverPaid = $('#neverPaidToggle').el.checked;
        
        // Toggle Visibility Logic
        if (statusFilter === 'pending') {
            $('#neverPaidFilterGroup').css('display', 'flex');
        } else {
            $('#neverPaidFilterGroup').hide();
        }

        // Filter
        let data = state.summary.filter(r => {
            const pend = parseMoney(r[2]);
            const pre = parseMoney(r[3]);
            
            if (statusFilter === 'pending') {
                const isPending = pend > 0;
                // "Never Paid" Check
                if (isPending && showNeverPaid) {
                    const coveredDate = r[9]; 
                    const hasNoDate = !coveredDate || coveredDate === '-' || coveredDate.trim() === '';
                    return hasNoDate;
                }
                return isPending;
            }

            if (statusFilter === 'prepaid') return pre > 0;
            if (statusFilter === 'balanced') return (pre - pend) === 0;
            return true;
        });

        // Sort
        if (state.sortBy) {
            data.sort((a, b) => {
                let valA, valB;
                switch(state.sortBy) {
                    case 'name': valA = a[1].toLowerCase(); valB = b[1].toLowerCase(); break;
                    case 'pending': valA = parseMoney(a[2]); valB = parseMoney(b[2]); break;
                    case 'prepay': valA = parseMoney(a[3]); valB = parseMoney(b[3]); break;
                    case 'total': valA = parseMoney(a[4]); valB = parseMoney(b[4]); break;
                    case 'lastDate': valA = parseDate(a[9]) || new Date(0); valB = parseDate(b[9]) || new Date(0); break;
                }
                return state.sortAsc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
        }

        let tPending = 0, tPrepay = 0, tPaid = 0;

        const html = data.map(r => {
            const name = r[1];
            const pend = parseMoney(r[2]);
            const pre = parseMoney(r[3]);
            const tot = parseMoney(r[4]);
            
            tPending += pend; tPrepay += pre; tPaid += tot;

            const actionBtn = pend > 0 
                ? `<button class="btn btn-primary copy-btn" data-name="${name}" data-amt="${pend}" data-date="${r[9] || ''}" style="padding:5px 10px; font-size:12px;">üìã Copy</button>` 
                : '';

            return `
                <tr>
                    <td><a href="#" class="text-link user-link" data-name="${name}">${name}</a></td>
                    <td class="${pend > 0 ? 'text-red' : ''}">${fmtMoney(pend)}</td>
                    <td class="${pre > 0 ? 'text-green' : ''}">${fmtMoney(pre)}</td>
                    <td style="font-weight:bold">${fmtMoney(tot)}</td>
                    <td>${r[9] || '-'}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        }).join('');

        $('#allPaymentsTable tbody').html(html);
        $('#totalPendingSum').text(fmtMoney(tPending));
        $('#totalPrepaySum').text(fmtMoney(tPrepay));
        $('#totalPaymentSum').text(fmtMoney(tPaid));
    }

    // --- Actions ---

    function selectUser(name) {
        state.currentUser = name;
        $('#nameSearch').val(name);
        $('#searchSuggestions').hide();
        
        const newUrl = `${window.location.pathname}?user=${encodeURIComponent(name)}`;
        window.history.pushState({path: newUrl}, '', newUrl);

        renderUserDashboard(name);
    }

    document.addEventListener('click', async (e) => {
        if (e.target.classList.contains('user-link')) {
            e.preventDefault();
            selectUser(e.target.dataset.name);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (e.target.classList.contains('copy-btn')) {
            const btn = e.target;
            const { name, amt, date } = btn.dataset;
            const link = `${window.location.origin}${window.location.pathname}?user=${encodeURIComponent(name)}`;
            const msg = `Hey ${name}, you have unpaid Frisbee field booking fees of ${parseFloat(amt).toFixed(2)} MVR pending since ${date || 'your last session'}.\nYou can view the session cost details at: ${link}\n\n Please pay to the following account: 7730000682000 (MOHD. AMSAL)`;
            
            try {
                await navigator.clipboard.writeText(msg);
                const oldTxt = btn.innerText;
                btn.innerText = "‚úì Copied";
                btn.style.background = "#2e7d32";
                setTimeout(() => { btn.innerText = oldTxt; btn.style.background = ""; }, 2000);
            } catch(err) { alert("Could not copy text."); }
        }
    });

    function setupEventListeners() {
        $('#nameSearch').on('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            if (!val) { $('#searchSuggestions').hide(); return; }
            
            const matches = state.users.filter(u => u.toLowerCase().includes(val)).slice(0, 10);
            if (matches.length) {
                const html = matches.map(name => 
                    `<button class="btn btn-secondary suggestion-btn" onclick="selectUser('${name}')">${name}</button>`
                ).join('');
                $('#suggestionList').html(html);
                $('#searchSuggestions').show();
            } else {
                $('#searchSuggestions').hide();
            }
        });

        $('#clearSearch').click(() => {
            $('#nameSearch').val('');
            $('#searchSuggestions').hide();
            $('#welcomeMessage').show();
            $('#userDashboard').hide();
            $('#allDataView').hide();
            window.history.pushState({}, '', window.location.pathname);
        });

        $('#showAllData').click(() => {
            state.sortBy = null; // reset sort
            renderAllPayments();
        });

        $('.att-filter').on('change', () => {
             renderAttendanceTable(state.attendance.filter(r => r[0] === state.currentUser));
        });
        
        // Chart Year Filter Listener
        $('#chartYearFilter').on('change', () => {
            if (state.currentUser) {
                const userRows = state.attendance.filter(r => r[0] === state.currentUser);
                renderActivityChart(userRows);
            }
        });

        $('#paymentStatusFilter').on('change', renderAllPayments);
        $('#neverPaidToggle').on('change', renderAllPayments);

        $('.close-modal, .close-modal-btn').on('click', () => $('#qrModal').hide());

        $('th[data-sort]').click(function() {
            const col = this.getAttribute('data-sort');
            if (state.sortBy === col) state.sortAsc = !state.sortAsc;
            else { state.sortBy = col; state.sortAsc = true; }
            
            $('th').removeClass('sort-asc').removeClass('sort-desc');
            $(this).addClass(state.sortAsc ? 'sort-asc' : 'sort-desc');

            if ($('#allDataView').el.style.display !== 'none') renderAllPayments();
            else renderAttendanceTable(state.attendance.filter(r => r[0] === state.currentUser));
        });
    }

    document.addEventListener('DOMContentLoaded', initApp);
    window.selectUser = selectUser;
</script>
</body>
</html>
